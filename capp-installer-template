#!/bin/bash
CAPP_VER=to_replace
COMPOSE_SYSTEMD_VER=1.2.0
def_cont_mem='10G'
set -e
if [ "$1" = "-v" ] || [ "$1" = "--version" ]; then
    echo "$CAPP_VER"
    exit 0
fi
if [ $(id -u) -ne 0 ]; then
    echo "Root required" >&2
    exit 1
fi
for bin in useradd usermod base64 curl docker-compose sudo tar unxz; do
    if ! which $bin >/dev/null 2>&1; then
        echo "$bin required" >&2
        exit 1
    fi
done
me=$(readlink -f "$0")
offset=$(($(sed -rn '/#{10}/=' "$me") + 1))
usage() {
    echo "$0 default_hostname default_email [container_max_memory_size=$def_cont_mem] [nohttps]" >&2
    echo "  container_max_memory_size should be expressed with M or G units" >&2
    exit 1
}
dh="$1"
[ -n "$dh" ] && shift || usage
de="$1"
[ -n "$dh" ] && shift || usage
cont_mem=
nohttps=0
while [ -n "$1" ]; do
    p="$1"
    shift
    case "$p" in
        nohttps)
            nohttps=1
            ;;
        *M|*G)
            if [ -z "$cont_mem" ]; then
                cont_mem="$p"
            else
                usage
            fi
            ;;
        *)
            usage
            ;;
    esac
done
[ -n "$cont_mem" ] || cont_mem=$def_cont_mem
cat > /etc/capp.conf <<EOF
max_mem_size=${cont_mem}
default_hostname=${dh}
EOF
mkdir -p /etc/capp/users /etc/capp/rights /etc/capp/hooks.d/{pre_deploy,post_deploy,pre_undeploy,post_undeploy}
tmpdir=$(mktemp -d)
cd $tmpdir
curl -Ls https://github.com/jrd/compose-systemd/archive/v${COMPOSE_SYSTEMD_VER}.tar.gz | tar xzf -
tail -n+$offset "$me" | base64 -d | tar xJf -
cp compose-systemd-${COMPOSE_SYSTEMD_VER}/compose-dirs.conf /etc/
cp compose-systemd-${COMPOSE_SYSTEMD_VER}/compose-dirs /usr/local/bin/
ln -sf $(which docker-compose) /usr/local/bin/dc
mkdir -p /var/docker-volumes/nginx-proxy/{vhost.d,certs} /etc/compose /home/deploy/dca
id -u compose >/dev/null 2>&1 || useradd --home-dir /etc/compose --no-create-home --user-group --shell /usr/sbin/nologin -c "Compose" -l compose
chown :compose /var/docker-volumes/nginx-proxy/vhost.d /etc/capp/users /etc/capp/rights
chmod g+w /var/docker-volumes/nginx-proxy/vhost.d /etc/capp/users /etc/capp/rights
cp -r proxy dca /etc/compose/
if [ "$nohttps" -eq 1 ]; then
    # delete the letsencrypt service
    sed -ri '/letsencrypt/,/certs:rw/d' /etc/compose/proxy/docker-compose.yml
    # do not bind the 443 port on the host
    sed -ri '/:443/d' /etc/compose/proxy/docker-compose.yml
    # do not redirect http access to https
    sed -ri '/Env\.HTTPS_METHOD/s/redirect/nohttps/' /etc/compose/proxy/nginx.tmpl
fi
sed -ri "s/dca:1000:1000/dca:$(id -u compose):$(id -g compose)/" /etc/compose/dca/docker-compose.yml
mkdir -p /usr/local/bin
cp capp verify_dca.py get_deploy_keys /usr/local/bin/
chown compose: /usr/local/bin/capp
cat > /etc/compose/proxy/.env <<EOF
DEFAULT_HOST=$dh
DEFAULT_EMAIL=$de
EOF
if [ -f /etc/compose/compose.deps ]; then
    for svc in proxy dca; do
        grep -q "^$svc:" /etc/compose/compose.deps || echo "$svc:" >> /etc/compose/compose.deps
    done
else
    cat > /etc/compose/compose.deps <<EOF
proxy:
dca:
EOF
fi
chown -R compose: ~compose
id -u deploy >/dev/null 2>&1 || useradd --no-create-home --user-group --password '*' -c "Deploy" deploy
cat > ~deploy/capp <<'EOF'
#!/bin/bash
set -f
SSH_ARRAY=()
while IFS="$(echo)" read -r V; do
  SSH_ARRAY+=("$V")
done <<< $(echo "$SSH_ORIGINAL_COMMAND" | sed -r 's/(^| )"/\n"/g; s/"( |$)/"\n/g;' | sed -r '/^[^"]/s/ /\n/g;' | grep -v '^$' | sed -r 's/^"//g; s/"$//g;')
set -- "${SSH_ARRAY[@]}"
exec sudo -u compose /usr/local/bin/capp "$@"
EOF
chmod +x ~deploy/capp
chmod g+w ~deploy/dca
chown -R deploy: ~deploy
chown -R :compose ~deploy/dca
grep -q '^PermitUserEnvironment yes' /etc/ssh/sshd_config || sed -ri '/^#PermitUserEnvironment /a PermitUserEnvironment yes' /etc/ssh/sshd_config
grep -q '^Match User deploy' /etc/ssh/sshd_config && ! grep -q '^ *AuthorizedKeysCommand' /etc/ssh/sshd_config && sed -ri '/^Match User deploy/,/^.*AuthorizedKeys.*/d' /etc/ssh/sshd_config
grep -q '^Match User deploy' /etc/ssh/sshd_config || cat >> /etc/ssh/sshd_config <<EOF
Match User deploy
	AllowAgentForwarding no
        AllowTcpForwarding no
        X11Forwarding no
        PermitTunnel no
        DisableForwarding yes
        PasswordAuthentication no
	ForceCommand /home/deploy/capp
        AuthorizedKeysFile /dev/null
        AuthorizedKeysCommand /usr/local/bin/get_deploy_keys
        AuthorizedKeysCommandUser compose
EOF
[ -e /etc/compose/dca/users-keys ] && rm /etc/compose/dca/users-keys
[ -e /etc/deploy-authorized-keys ] && rm /etc/deploy-authorized-keys
[ -e /etc/dca-authorized-keys ] && rm /etc/dca-authorized-keys
touch /var/log/capp.log
chown compose: /var/log/capp.log
chmod g+w /var/log/capp.log
groups compose | grep -q '\<docker\>' || usermod -a -G docker compose
groups compose | grep -q '\<systemd-journal\>' || usermod -a -G systemd-journal compose
groups compose | grep -q '\<deploy\>' || usermod -a -G deploy compose
cat > /etc/sudoers.d/compose <<EOF
# Allow members of compose group to execute compose-dirs command
Cmnd_Alias COMPOSE_DIRS = /usr/local/bin/compose-dirs
Cmnd_Alias COMPOSE_SVC = /usr/bin/systemctl start compose@*, /usr/bin/systemctl stop compose@*, /usr/bin/systemctl restart compose@*
Cmnd_Alias CAPP_HOOKS = /etc/capp/hooks.d/pre_deploy/*, /etc/capp/hooks.d/post_deploy/*, /etc/capp/hooks.d/pre_undeploy/*, /etc/capp/hooks.d/post_undeploy/*
%compose   ALL= NOPASSWD: COMPOSE_DIRS, COMPOSE_SVC, CAPP_HOOKS
EOF
cat > /etc/sudoers.d/deploy <<EOF
# Allow members of deploy group to execute capp command
Defaults env_keep="SSH_USER"
Cmnd_Alias CAPP_CMD = /usr/local/bin/capp
%deploy   ALL=(compose) NOPASSWD: CAPP_CMD
EOF
chmod u=r,g=r,o= /etc/sudoers.d/{compose,deploy}
cd /etc/compose/dca
docker-compose pull
cd /etc/compose/proxy
docker-compose pull
rm -rf $tmpdir
set -x
/usr/local/bin/compose-dirs install
/usr/local/bin/compose-dirs update
/usr/local/bin/compose-dirs start
exit 0
##########
